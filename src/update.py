# Third-Party Imports
import sys

import pefile
import pandas as pd


def update(malware_filename, is_malware):
    # variables
    function_calls = list()

    print("\tLoading in the data...")
    data = pd.read_csv('../data/pe_imports.csv')
    blah_data = data.drop('malware', axis=1)
    columns = blah_data.columns.values.tolist()

    # gather all function calls
    try:
        pe = pefile.PE(malware_filename)
        if hasattr(pe, "DIRECTORY_ENTRY_IMPORT"):
            for entry in pe.DIRECTORY_ENTRY_IMPORT:
                for function_call in entry.imports:
                    print("Import: {}".format(function_call.name.decode('utf-8')))
                    function_calls.append(function_call.name.decode('utf-8'))
    except Exception:
        raise Exception("Error listing function calls within {}".format(malware_filename))

    # TODO: Need to check to see if hash already in dataframe

    # append new row to dataframe
    new_row = list()
    for column in columns:
        if column in function_calls:
            new_row.append(1)
        else:
            new_row.append(0)

    # if malware, append a 1
    if is_malware:
        new_row.append(1)
    else:
        new_row.append(0)

    data.loc[len(data)] = new_row
    data.to_csv(r'../data/pe_imports.csv', index=False)
